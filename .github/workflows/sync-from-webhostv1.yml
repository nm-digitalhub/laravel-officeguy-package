---
name: Sync Laravel Package from WebhostV1

'on':
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Source repository (owner/repo)'
        required: true
        default: 'nm-digitalhub/webhostV1'
      source_directory:
        description: 'Directory to copy from source repository'
        required: true
        default: 'laravel-officeguy-package'
      target_repo:
        description: 'Target repository (owner/repo)'
        required: true
        default: 'nm-digitalhub/laravel-officeguy-package'
      source_branch:
        description: 'Branch to pull from source repository'
        required: true
        default: 'main'
      target_branch:
        description: 'Branch to push to target repository'
        required: true
        default: 'main'

jobs:
  sync-contents:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target_repo }}
          ref: ${{ inputs.target_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}
          path: target-repo

      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.source_repo }}
          ref: ${{ inputs.source_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}
          path: source-repo

      - name: Copy directory contents
        run: |
          SRC_DIR="${{ inputs.source_directory }}"
          SRC_REPO="${{ inputs.source_repo }}"
          echo "Copying contents from $SRC_DIR in $SRC_REPO"

          # Create intermediate directory
          mkdir -p /tmp/sync-contents

          # Check if source directory exists
          if [ ! -d "source-repo/$SRC_DIR" ]; then
            echo "Error: Source directory does not exist"
            exit 1
          fi

          # Copy contents from source directory to intermediate location
          cp -r source-repo/$SRC_DIR/* /tmp/sync-contents/

          # List copied files for verification
          echo "Files copied to intermediate location:"
          ls -la /tmp/sync-contents/

          # Remove existing contents from target (except .git and .github)
          cd target-repo
          find . -mindepth 1 -maxdepth 1 \
            ! -name '.git' ! -name '.github' -exec rm -rf {} +

          # Copy from intermediate location to target
          cp -r /tmp/sync-contents/* .

          echo "Contents synchronized successfully"

      - name: Configure Git
        working-directory: target-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push changes
        working-directory: target-repo
        run: |
          git add .

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            SRC_REPO="${{ inputs.source_repo }}"
            SRC_DIR="${{ inputs.source_directory }}"
            git commit -m "Sync contents from $SRC_REPO/$SRC_DIR"
            git push origin ${{ inputs.target_branch }}
            echo "Changes pushed successfully"
          fi
